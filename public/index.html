<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delhi Bus Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        .map-container { position: relative; width: 100%; height: 100%; }
        .map-container.fullscreen { height: 100vh; width: 100vw; }
        .leaflet-control-exit-zoom { background: #fff; padding: 5px 10px; cursor: pointer; display: none; }
        .leaflet-control-exit-zoom.visible { display: block; }
        .bus-label { color: #fff; background: rgba(0, 0, 0, 0.7); text-align: center; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="map-container">
        <div id="map" style="width: 100%; height: 100%;"></div>
        <button onclick="toggleFullscreen()" style="position: absolute; top: 10px; left: 10px; z-index: 1000;">Toggle Fullscreen</button>
    </div>

    <script>
        // Initialize the map
        const map = L.map('map', { center: [28.6139, 77.2090], zoom: 12 });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        document.addEventListener('DOMContentLoaded', () => map.invalidateSize());

        // Custom icons
        const baseIconSize = [35, 18];
        const busIcon = L.icon({ iconUrl: '/bus-icon.png', iconSize: baseIconSize, iconAnchor: [baseIconSize[0] / 2, baseIconSize[1] / 2], popupAnchor: [0, -baseIconSize[1] / 2] });
        const stopIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png', iconSize: [25, 25], iconAnchor: [12.5, 25], popupAnchor: [0, -25] });
        const userIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [38, 38], iconAnchor: [19, 38], popupAnchor: [0, -38] });

        let userMarker = null;
        const busMarkers = {};
        const busStopMarkers = {};
        let allBuses = [];

        // Exit Zoom Control
        const ExitZoomControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-exit-zoom');
                container.innerHTML = 'X';
                container.onclick = () => map.setZoom(12);
                return container;
            }
        });
        const exitZoomControl = new ExitZoomControl().addTo(map);

        function toggleExitZoomButton() {
            const zoomLevel = map.getZoom();
            document.querySelector('.leaflet-control-exit-zoom').classList.toggle('visible', zoomLevel > 12);
        }

        function adjustMarkerSize(zoom) {
            const scale = zoom < 12 ? 0.5 : zoom < 14 ? 0.75 : 1;
            const newIconSize = [baseIconSize[0] * scale, baseIconSize[1] * scale];
            const newLabelSize = [30 * scale, 15 * scale];
            const newStopSize = [25 * scale, 25 * scale];

            Object.values(busMarkers).forEach(({ marker, label }) => {
                marker.setIcon(L.icon({ iconUrl: '/bus-icon.png', iconSize: newIconSize, iconAnchor: [newIconSize[0] / 2, newIconSize[1] / 2], popupAnchor: [0, -newIconSize[1] / 2] }));
                label.setIcon(L.divIcon({ className: 'bus-label', html: label.getElement().innerHTML, iconSize: newLabelSize, iconAnchor: [newLabelSize[0] / 2, newLabelSize[1] + 5 * scale] }));
            });

            Object.values(busStopMarkers).forEach(marker => {
                marker.setIcon(L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3082/3082383.png', iconSize: newStopSize, iconAnchor: [newStopSize[0] / 2, newStopSize[1]], popupAnchor: [0, -newStopSize[1]] }));
            });
        }

        function filterBusesInBounds(buses) {
            const bounds = map.getBounds();
            return buses.filter(bus => bounds.contains([bus.latitude, bus.longitude]));
        }

        function updateBusMarkers(buses) {
            allBuses = buses;
            const visibleBuses = filterBusesInBounds(buses);

            Object.keys(busMarkers).forEach(busNo => {
                if (!visibleBuses.find(bus => bus.busNo === busNo)) {
                    map.removeLayer(busMarkers[busNo].marker);
                    map.removeLayer(busMarkers[busNo].label);
                    delete busMarkers[busNo];
                }
            });

            visibleBuses.forEach(bus => {
                const { busNo, latitude, longitude, routeNo } = bus;
                if (busMarkers[busNo]) {
                    const marker = busMarkers[busNo].marker;
                    const label = busMarkers[busNo].label;
                    const newLatLng = new L.LatLng(latitude, longitude);
                    animateMarker(marker, marker.getLatLng(), newLatLng);
                    label.setLatLng(newLatLng);
                    marker.setPopupContent(`Bus: ${busNo}<br>Route: ${routeNo}<br>Lat: ${latitude}<br>Lon: ${longitude}`);
                    label.getElement().innerHTML = routeNo;
                } else {
                    const marker = L.marker([latitude, longitude], { icon: busIcon })
                        .addTo(map)
                        .bindPopup(`Bus: ${busNo}<br>Route: ${routeNo}<br>Lat: ${latitude}<br>Lon: ${longitude}`);
                    const label = L.marker([latitude, longitude], {
                        icon: L.divIcon({ className: 'bus-label', html: routeNo, iconSize: [30, 15], iconAnchor: [15, 20] })
                    }).addTo(map);
                    busMarkers[busNo] = { marker, label };
                }
            });

            adjustMarkerSize(map.getZoom());
        }

        function updateBusStopMarkers(stops) {
            const bounds = map.getBounds();
            stops.forEach(stop => {
                const { name, latitude, longitude } = stop;
                const key = `${latitude},${longitude}`;
                if (bounds.contains([latitude, longitude]) && !busStopMarkers[key]) {
                    const marker = L.marker([latitude, longitude], { icon: stopIcon })
                        .addTo(map)
                        .bindPopup(`Stop: ${name}<br>Lat: ${latitude}<br>Lon: ${longitude}`);
                    busStopMarkers[key] = marker;
                }
            });

            Object.keys(busStopMarkers).forEach(key => {
                const [lat, lng] = key.split(',').map(Number);
                if (!bounds.contains([lat, lng])) {
                    map.removeLayer(busStopMarkers[key]);
                    delete busStopMarkers[key];
                }
            });

            adjustMarkerSize(map.getZoom());
        }

        function animateMarker(marker, startLatLng, endLatLng) {
            let startTime = null;
            const duration = 1000;
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = (timestamp - startTime) / duration;
                if (progress < 1) {
                    const lat = startLatLng.lat + (endLatLng.lat - startLatLng.lat) * progress;
                    const lng = startLatLng.lng + (endLatLng.lng - startLatLng.lng) * progress;
                    marker.setLatLng([lat, lng]);
                    const label = busMarkers[marker._popup._content.split('<br>')[0].replace('Bus: ', '')].label;
                    label.setLatLng([lat, lng]);
                    requestAnimationFrame(animate);
                } else {
                    marker.setLatLng(endLatLng);
                }
            }
            requestAnimationFrame(animate);
        }

        function toggleFullscreen() {
            const mapContainer = document.querySelector('.map-container');
            if (!document.fullscreenElement) {
                mapContainer.classList.add('fullscreen');
                mapContainer.requestFullscreen().then(() => map.invalidateSize());
            } else {
                mapContainer.classList.remove('fullscreen');
                document.exitFullscreen().then(() => map.invalidateSize());
            }
        }

        // Geolocation
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const { latitude, longitude } = position.coords;
                map.setView([latitude, longitude], 15);
                if (userMarker) {
                    userMarker.setLatLng([latitude, longitude]);
                } else {
                    userMarker = L.marker([latitude, longitude], { icon: userIcon })
                        .addTo(map)
                        .bindPopup('You are here');
                }
                fetchInitialData();
            },
            () => fetchInitialData()
        );

        // Fetch initial data
        function fetchInitialData() {
            fetch('/api/bus')
                .then(response => response.json())
                .then(data => {
                    updateBusMarkers(data.buses);
                    updateBusStopMarkers(data.busStops);
                });
        }

        // Socket.IO connection
        const socket = io('https://your-socket-server.com'); // Replace with your Socket.IO server URL
        socket.on('busUpdate', (data) => updateBusMarkers(data.buses));

        map.on('moveend zoomend', () => {
            updateBusMarkers(allBuses);
            toggleExitZoomButton();
        });

        toggleExitZoomButton();
    </script>
</body>
</html>